---
- name: Destroy Kubernetes cluster and clean all nodes
  hosts: all
  become: true
  any_errors_fatal: true
  serial: 1

  vars:
    k8s_packages:
      - kubelet
      - kubeadm
      - kubectl

    container_packages:
      - containerd
      - containernetworking-plugins

    base_packages:
      - nfs-common
      - ipvsadm
      - net-tools
      - openvswitch-switch
      - openvswitch-common

  tasks:
    # --------------------------------------------------
    # Pre-flight: stop services if present
    # --------------------------------------------------
    - name: Stop kubelet if running
      ansible.builtin.systemd:
        name: kubelet
        state: stopped
        enabled: false
      ignore_errors: true

    - name: Stop containerd if running
      ansible.builtin.systemd:
        name: containerd
        state: stopped
        enabled: false
      ignore_errors: true

    - name: Unmount containerd mounts
      ansible.builtin.shell: |
        mount | grep containerd | awk '{print $3}' | xargs -r umount -lf
      ignore_errors: true


    # --------------------------------------------------
    # Reset kubeadm (safe even if not initialized)
    # --------------------------------------------------
    - name: Reset kubeadm
      ansible.builtin.command: kubeadm reset -f
      ignore_errors: true

    # --------------------------------------------------
    # Remove Kubernetes manifests and state
    # --------------------------------------------------
    - name: Remove Kubernetes directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/kubernetes
        - /var/lib/kubelet
        - /var/lib/etcd
        - /var/lib/cni
        - /etc/cni
        - /opt/cni
        - /run/antrea
        - /run/containerd
        - /var/run/kubernetes

    # --------------------------------------------------
    # Flush iptables & IPVS (critical)
    # --------------------------------------------------
    - name: Flush iptables
      ansible.builtin.shell: |
        iptables -F
        iptables -t nat -F
        iptables -t mangle -F
        iptables -X
      changed_when: false

    - name: Reset IPVS tables
      ansible.builtin.command: ipvsadm --clear
      ignore_errors: true

    # --------------------------------------------------
    # Delete all container images & containers
    # --------------------------------------------------
    - name: Start containerd temporarily (for cleanup)
      ansible.builtin.systemd:
        name: containerd
        state: started
      ignore_errors: true

    - name: Delete all containers (crictl)
      ansible.builtin.shell: |
        crictl ps -aq | xargs -r crictl rm -f
      ignore_errors: true
      changed_when: false

    - name: Delete all images (crictl)
      ansible.builtin.shell: |
        crictl images -q | xargs -r crictl rmi
      ignore_errors: true
      changed_when: false

    - name: Stop containerd after cleanup
      ansible.builtin.systemd:
        name: containerd
        state: stopped
      ignore_errors: true

    # --------------------------------------------------
    # Remove packages
    # --------------------------------------------------
    - name: Unhold Kubernetes packages
      ansible.builtin.command: apt-mark unhold kubelet kubeadm kubectl
      changed_when: false
      ignore_errors: true

    - name: Purge Kubernetes packages
      ansible.builtin.apt:
        name: "{{ k8s_packages }}"
        state: absent
        purge: yes
        autoremove: yes

    - name: Purge container runtime packages
      ansible.builtin.apt:
        name: "{{ container_packages }}"
        state: absent
        purge: yes
        autoremove: yes

    - name: Remove base packages
      ansible.builtin.apt:
        name: "{{ base_packages }}"
        state: absent
        purge: yes
        autoremove: yes

    # --------------------------------------------------
    # Remove apt repos & keys
    # --------------------------------------------------
    - name: Remove Kubernetes apt repo
      ansible.builtin.file:
        path: /etc/apt/sources.list.d/kubernetes.list
        state: absent

    - name: Remove Kubernetes apt keyring
      ansible.builtin.file:
        path: /etc/apt/keyrings/kubernetes-apt-keyring.gpg
        state: absent

    # --------------------------------------------------
    # Final cleanup
    # --------------------------------------------------
    - name: Remove configs
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop: 
        - /etc/containerd
        - /etc/crictl.yaml
        - /etc/sysctl.d/99-kubernetes-cri.conf
        - /etc/sysctl.d/99-disable-ipv6.conf
        - /etc/modules-load.d/antrea.conf
        - /etc/modules-load.d/containerd.conf
        - /etc/modules-load.d/k8s.conf

    - name: Unload Antrea-related kernel modules
      become: true
      ansible.builtin.modprobe:
        name: "{{ item }}"
        state: absent
      loop:
        - geneve
        - vxlan
        - openvswitch
        - nf_nat
        - nf_conntrack
        - ip_tables
        - br_netfilter
        - overlay
      failed_when: false

    # --------------------------------------------------
    # Remove cgroups settings 
    # --------------------------------------------------
    - name: Remove cgroups configuration
      become: true
      shell: |
        FILE=""
        for f in /boot/cmdline.txt /boot/firmware/cmdline.txt /boot/firmware/current/cmdline.txt; do
          [ -f "$f" ] && FILE="$f"
        done

        if [ -n "$FILE" ]; then
          awk '{
            for (i=1; i<=NF; i++) {
              if ($i != "cgroup_enable=cpuset" &&
                  $i != "cgroup_enable=memory" &&
                  $i != "cgroup_memory=1") {
                printf "%s%s", $i, (i<NF ? OFS : ORS)
              }
            }
          }' $FILE > /tmp/cmdline.txt && mv /tmp/cmdline.txt $FILE
        fi
      changed_when: false

    # --------------------------------------------------
    # Detect reboot requirement
    # --------------------------------------------------
    - name: Check if reboot is required
      ansible.builtin.stat:
        path: /var/run/reboot-required
      register: reboot_flag

    - name: Accumulate reboot requirement (apt)
      ansible.builtin.set_fact:
        reboot_required: "{{ reboot_required | default(true) or reboot_flag.stat.exists }}"

- import_playbook: reboot-playbook.yaml
