# --------------------------------------------------
# Base OS updates
# --------------------------------------------------
- import_playbook: ../playbooks/apt-update-playbook.yaml

# --------------------------------------------------
# Kubernetes APT repository
# --------------------------------------------------
- name: Ensure Kubernetes APT repository
  hosts: all
  become: true
  gather_facts: false

  tasks:
    - name: Ensure apt keyrings directory exists
      file:
        path: /etc/apt/keyrings
        state: directory
        mode: "0755"

    - name: Install Kubernetes signing key
      shell: |
        curl -fsSL https://pkgs.k8s.io/core:/stable:/v{{ k8s.version }}/deb/Release.key \
        | gpg --dearmor --yes -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
      args:
        creates: /etc/apt/keyrings/kubernetes-apt-keyring.gpg

    - name: Configure Kubernetes repository
      copy:
        dest: /etc/apt/sources.list.d/kubernetes.list
        mode: "0644"
        content: |
          deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v{{ k8s.version }}/deb/ /

    - name: Update apt cache
      apt:
        update_cache: yes

# --------------------------------------------------
# Control Plane Upgrade
# --------------------------------------------------
- name: Upgrade Kubernetes control plane (if required)
  hosts: control_plane
  become: true
  any_errors_fatal: true

  tasks:
    - name: Detect installed Kubernetes version
      command: kubeadm version -o short
      register: installed_k8s
      changed_when: false

    - name: Normalize installed Kubernetes version
      set_fact:
        installed_k8s_version: "{{ installed_k8s.stdout | regex_replace('^v', '') }}"

    - name: Normalize target Kubernetes version
      set_fact:
        target_k8s_version: "{{ k8s.minor_version | regex_replace('^v', '') }}"

    - name: Determine if upgrade is required
      set_fact:
        upgrade_required: "{{ installed_k8s_version != target_k8s_version }}"

    - name: Show upgrade decision
      debug:
        msg: >
          Installed={{ installed_k8s_version }},
          Target={{ target_k8s_version }},
          UpgradeRequired={{ upgrade_required }}

    - name: Upgrade kubeadm
      when: upgrade_required
      shell: |
        apt-mark unhold kubeadm
        apt-get update
        apt-get install -y kubeadm
        apt-mark hold kubeadm
        kubeadm upgrade node

    - name: Pull Kubernetes images
      when: upgrade_required
      command: kubeadm config images pull

    - name: Upgrade control plane
      when: upgrade_required
      command: kubeadm upgrade apply {{ k8s.minor_version }} -f -y

    - name: Upgrade kubelet and kubectl
      when: upgrade_required
      shell: |
        apt-mark unhold kubelet kubectl
        apt-get install -y kubelet kubectl
        apt-mark hold kubelet kubectl

    - name: Restart kubelet
      when: upgrade_required
      systemd:
        name: kubelet
        state: restarted
        daemon_reload: true

# --------------------------------------------------
# Worker Nodes Upgrade (Zero Downtime)
# --------------------------------------------------
- name: Upgrade Kubernetes worker nodes (if required)
  hosts: worker_nodes
  become: true
  any_errors_fatal: true
  serial: 1

  tasks:
    - name: Detect installed Kubernetes version
      command: kubeadm version -o short
      register: installed_k8s
      changed_when: false

    - name: Normalize installed Kubernetes version
      set_fact:
        installed_k8s_version: "{{ installed_k8s.stdout | regex_replace('^v', '') }}"

    - name: Normalize target Kubernetes version
      set_fact:
        target_k8s_version: "{{ k8s.minor_version | regex_replace('^v', '') }}"

    - name: Determine if upgrade is required
      set_fact:
        upgrade_required: "{{ installed_k8s_version != target_k8s_version }}"

    - name: Show upgrade decision
      debug:
        msg: >
          Installed={{ installed_k8s_version }},
          Target={{ target_k8s_version }},
          UpgradeRequired={{ upgrade_required }}

    - name: Drain node
      when: upgrade_required
      shell: |
        kubectl drain {{ inventory_hostname }} \
          --ignore-daemonsets \
          --delete-emptydir-data
      delegate_to: localhost
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf

    - name: Upgrade kubeadm
      when: upgrade_required
      shell: |
        apt-mark unhold kubeadm
        apt-get update
        apt-get install -y kubeadm
        apt-mark hold kubeadm
        kubeadm upgrade node

    - name: Upgrade kubelet and kubectl
      when: upgrade_required
      shell: |
        apt-mark unhold kubelet kubectl
        apt-get install -y kubelet kubectl
        apt-mark hold kubelet kubectl

    - name: Restart kubelet
      when: upgrade_required
      systemd:
        name: kubelet
        state: restarted
        daemon_reload: true

    - name: Uncordon node
      when: upgrade_required
      shell: kubectl uncordon {{ inventory_hostname }}
      delegate_to: localhost
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf

# --------------------------------------------------
# Reboot if required
# --------------------------------------------------
- import_playbook: ../playbooks/reboot-playbook.yaml
